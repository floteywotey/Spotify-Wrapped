{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Wrapped</title>
    <link rel="stylesheet" href="{% static 'SpotifyWrapped/duo_results.css' %}">
</head>
<body>
<div class="header">
    <form class="home" action="{% url 'home' %}" method="post">
        {% csrf_token %}
        <button class="home-button" aria-label="Home" title="Home">
            <img src="{% static 'SpotifyWrapped/images/icons/close_presentation.svg' %}" height="30px" width="30px" alt="Close">
        </button>
    </form>
</div>

<div class="cards">
    <!-- Card 1 -->
    <div class="card1" id="card1">
        <!-- Card Back -->
        <div class="card-back" id="back1"></div>
        <!-- Card Front -->
        <div class="card-front" id="front1">
            <!-- Info for shared tracks -->
            <div class="info fade" id="info1">
                <div class="scenario">
                    <p>The cards reveal harmony—your musical fates are entwined! Together, you've found a shared rhythm in the stars.</p>
                </div>
                {% for track in wrap.duowrap.top_tracks|slice:":3" %}
                <div class="details">
                    <img src="{{ track.image }}" height="33" width="33" alt="{{ track.name }}">
                    <div class="bullet">
                        <img class="fbullet-img" data-index="{{ forloop.counter }}" height="10px" width="10px" alt="Bullet Point">
                    </div>
                    <div class="text">
                        <h2>{{ track.name }}</h2>
                        <h3>{{ track.artists }}</h3>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Info for no shared tracks -->
            <div class="info fade" id="info1-none">
                <div class="scenario">
                    <p>The cards reveal a curious divergence—your musical fates have yet to intertwine. Explore new paths, and perhaps the stars will align for a shared melody.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2 -->
    <div class="card2" id="card2">
        <!-- Card Back -->
        <div class="card-back" id="back2"></div>
        <!-- Card Front -->
        <div class="card-front" id="front2">
            <!-- Info for shared artists -->
            <div class="info fade" id="info2">
                <div class="scenario">
                    <p>The Wheel of Fortune turns, revealing a shared rhythm between you both. Your love for the same artists is no mere coincidence—it’s a sign of the universe composing a duet meant to be discovered.</p>
                </div>
                {% for artist in wrap.duowrap.top_artists|slice:":3" %}
                <div class="details">
                    <img src="{{ artist.image }}" height="33" width="33" alt="{{ artist.name }}">
                    <div class="bullet">
                        <img class="fbullet-img" data-index="{{ forloop.counter }}" height="10px" width="10px" alt="Bullet Point">
                    </div>
                    <div class="text">
                        <h2>{{ artist.name }}</h2>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Info for no shared artists -->
            <div class="info fade" id="info2-none">
                <div class="scenario">
                    <p>Like The Lovers reversed, your favorite artists may seem worlds apart. Perhaps your differing sounds are meant to create a duet of discovery, inspiring each other to explore new musical realms.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Function to set up card interactions
        function setupCardInfo(cardSelector, infoSelector, noneSelector, length) {
            const card = document.querySelector(cardSelector);
            const info = document.querySelector(infoSelector);
            const none = document.querySelector(noneSelector);

            card.addEventListener("mouseenter", () => {
                if (length !== 0) {
                    info.style.display = "flex";
                    none.style.display = "none";
                } else {
                    info.style.display = "none";
                    none.style.display = "flex";
                }
            });

            card.addEventListener("mouseleave", () => {
                info.style.display = "none";
                none.style.display = "none";
            });
        }

        // Set up cards
        setupCardInfo("#card1", "#info1", "#info1-none", {{ wrap.duowrap.numSharedTracks }});
        setupCardInfo("#card2", "#info2", "#info2-none", {{ wrap.duowrap.numSharedArtists }});

        // Function to handle card splitting animation
        function splitCard(card) {
            const front = card.querySelector(".card-front");
            front.style.opacity = "0"; // Hide the front
            const frontBackground = getComputedStyle(front).background;

            // Create split elements
            const leftHalf = document.createElement("div");
            leftHalf.classList.add("split-left");
            leftHalf.style.background = frontBackground;

            const rightHalf = document.createElement("div");
            rightHalf.classList.add("split-right");
            rightHalf.style.background = frontBackground;

            // Append split halves to the card
            card.appendChild(leftHalf);
            card.appendChild(rightHalf);

            // Restore the card-front after animation completes
            setTimeout(() => {
                leftHalf.remove();
                rightHalf.remove();
                front.style.opacity = "1"; // Restore visibility
            }, 3000); // Duration of the split animation
        }

        let isAnimating = false;

        // Add event listener to cards
        const cards = document.querySelectorAll(".cards > div");
        cards.forEach(card => {
            card.addEventListener("click", function () {
                if (isAnimating) return;

                isAnimating = true;

                const lastFlippedCard = Array.from(cards).find(c => c !== this && c.classList.contains("clicked"));
                if (lastFlippedCard) {
                    lastFlippedCard.classList.remove("clicked");
                }

                card.classList.toggle("clicked");

                setTimeout(() => {
                    if (card.classList.contains("clicked")) {
                        splitCard(card);
                    }
                }, 600);

                setTimeout(() => {
                    isAnimating = false;
                }, 3000);
            });
        });

        // Dynamically assign bullet images
        const bulletImages = [
            "{% static 'SpotifyWrapped/images/decorations/bullets/bullet1.svg' %}",
            "{% static 'SpotifyWrapped/images/decorations/bullets/bullet2.svg' %}",
            "{% static 'SpotifyWrapped/images/decorations/bullets/bullet3.svg' %}",
            "{% static 'SpotifyWrapped/images/decorations/bullets/bullet4.svg' %}",
            "{% static 'SpotifyWrapped/images/decorations/bullets/bullet5.svg' %}"
        ];
        document.querySelectorAll('.fbullet-img').forEach((bullet, index) => {
            bullet.src = bulletImages[index % bulletImages.length];
        });
    });
</script>
</body>
</html>
